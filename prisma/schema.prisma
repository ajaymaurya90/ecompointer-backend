generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////
// ENUMS
//////////////////////////////

enum OrderStatus {
  PENDING
  CONFIRMED
  DISPATCHED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PARTIALLY_PAID
  PAID
}

enum Role {
  BRAND_OWNER
  SHOP_OWNER
  SUPER_ADMIN
  CUSTOMER

}

//////////////////////////////
// CORE USERS
//////////////////////////////

model User {
  id        String  @id @default(uuid())
  email     String  @unique
  firstName  String
  lastName   String?
  phone      String   @unique
  password  String
  role      Role
  isActive  Boolean @default(true)

  brandOwner BrandOwner?
  shopOwner  ShopOwner?

  refreshToken String?
  tokenVersion Int     @default(0)

  isDeleted Boolean @default(false)
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model BrandOwner {
  id        String  @id @default(uuid())
  businessName String
  phone     String?
  gstNumber   String?
  address     String?
  state       String?
  city        String?
  country     String?
  logoUrl   String?
  isActive  Boolean @default(true)

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  brands    ProductBrand[]
  categories ProductCategory[]
  products  Product[]
  shopLinks BrandOwnerShop[]
  orders    Order[]

  language String? @default("en")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ShopOwner {
  id        String  @id @default(uuid())
  shopName  String
  ownerName String
  phone     String
  email     String?
  address   String?
  shopSlug  String  @unique
  qrCodeUrl String?
  isActive  Boolean @default(true)
  language  String? @default("en")

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  brandLinks BrandOwnerShop[]
  orders     Order[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([shopSlug])
}

//////////////////////////////
// MANY TO MANY RELATION
//////////////////////////////

model BrandOwnerShop {
  id           String @id @default(uuid())
  brandOwnerId String
  shopOwnerId  String

  brandOwner BrandOwner @relation(fields: [brandOwnerId], references: [id], onDelete: Cascade)
  shopOwner  ShopOwner  @relation(fields: [shopOwnerId], references: [id], onDelete: Cascade)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([brandOwnerId, shopOwnerId])
  @@index([brandOwnerId])
  @@index([shopOwnerId])
}

//////////////////////////////
// PRODUCT DOMAIN
//////////////////////////////

model ProductBrand {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())

  ownerId String
  owner   BrandOwner @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  products   Product[]

  @@index([ownerId])
}

model ProductCategory {
  id   String @id @default(uuid())
  name String
  description   String?

  brandOwnerId  String
  brandOwner    BrandOwner @relation(fields: [brandOwnerId], references: [id])

  // Self-referencing hierarchy
  parentId String?
  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children ProductCategory[] @relation("CategoryHierarchy")

  products Product[]

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Prevent duplicate category names at same level under same brand
  @@unique([brandOwnerId, name, parentId])
  @@index([brandOwnerId])
  @@index([parentId])
}

model Product {
  id          String @id @default(uuid())
  name        String
  productCode String

  brandId String
  brand   ProductBrand @relation(fields: [brandId], references: [id])

  brandOwnerId  String
  brandOwner    BrandOwner @relation(fields: [brandOwnerId], references: [id])

  categoryId String
  category   ProductCategory @relation(fields: [categoryId], references: [id])

  description String?
  isActive    Boolean @default(true)

  variants ProductVariant[]
  media Media[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([brandId, productCode])
}

model ProductVariant {
  id String @id @default(uuid())

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  sku String @unique

  size  String?
  color String?

  taxRate   Float
  costPrice Float

  wholesaleNet   Float
  wholesaleGross Float

  retailNet   Float
  retailGross Float

  stock    Int     @default(0)
  isActive Boolean @default(true)

  inventories ProductInventory[]
  orderItems  OrderItem[]
  media Media[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductInventory {
  id               String         @id @default(uuid())
  productVariantId String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)

  quantity      Int
  warehouseName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productVariantId])
}

//////////////////////////////
// ORDER DOMAIN
//////////////////////////////

model Order {
  id          String @id @default(uuid())
  orderNumber String @unique

  brandOwnerId String
  shopOwnerId  String

  brandOwner BrandOwner @relation(fields: [brandOwnerId], references: [id])
  shopOwner  ShopOwner  @relation(fields: [shopOwnerId], references: [id])

  totalAmount Decimal @db.Decimal(12, 2)

  status        OrderStatus
  paymentStatus PaymentStatus

  items    OrderItem[]
  payments OrderPayment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandOwnerId])
  @@index([shopOwnerId])
}

model OrderItem {
  id String @id @default(uuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productVariantId String
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])

  quantity     Int
  priceAtOrder Decimal @db.Decimal(10, 2)
  totalPrice   Decimal @db.Decimal(12, 2)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productVariantId])
}

model OrderPayment {
  id String @id @default(uuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  amountPaid  Decimal  @db.Decimal(12, 2)
  paymentDate DateTime
  note        String?

  createdAt DateTime @default(now())

  @@index([orderId])
}

//////////////////////////////
// MEDIA
//////////////////////////////

enum MediaType {
  THUMBNAIL
  GALLERY
  ZOOM
  VIDEO
}

model Media {
  id         String   @id @default(uuid())

  productId  String?
  product    Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  variantId  String?
  variant    ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  url        String
  altText    String?

  type       MediaType @default(GALLERY)
  size       Int?
  mimeType   String?
  isPrimary  Boolean   @default(false)
  sortOrder  Int       @default(0)

  isActive   Boolean   @default(true)

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([productId])
  @@index([variantId])


}
